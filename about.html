<!DOCTYPE html>
<html>
  <head>
    <title>Toamig - About</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" href="logo_head.svg" type="image/svg+xml">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" type="text/css" href="about.css">
    <script>
      // Add smooth scroll behavior when arrow is pressed
      document.addEventListener('DOMContentLoaded', function() {
        var scrollDownArrow = document.querySelector('#about-2 .scroll-down a');
        if (scrollDownArrow) {
          scrollDownArrow.addEventListener('click', function(event) {
            event.preventDefault();
            var target = document.querySelector(this.getAttribute('href'));
            if (target) {
              target.scrollIntoView({ behavior: 'smooth' });
            }
          });
        }

        // Hamburger menu toggle
        var hamburger = document.querySelector('.hamburger');
        var navMenu = document.querySelector('.nav-menu');
        if (hamburger && navMenu) {
          hamburger.addEventListener('click', function() {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
            document.body.classList.toggle('menu-open');
          });

          // Close menu when clicking on a link
          var navLinks = navMenu.querySelectorAll('a');
          navLinks.forEach(function(link) {
            link.addEventListener('click', function() {
              hamburger.classList.remove('active');
              navMenu.classList.remove('active');
              document.body.classList.remove('menu-open');
            });
          });

          // Close menu when clicking outside
          document.addEventListener('click', function(event) {
            if (!hamburger.contains(event.target) && !navMenu.contains(event.target)) {
              hamburger.classList.remove('active');
              navMenu.classList.remove('active');
              document.body.classList.remove('menu-open');
            }
          });
        }

        // Music Player - Cross-page persistence with seamless playback
        var musicPlayer = document.getElementById('backgroundMusic');
        var musicToggle = document.getElementById('musicToggle');
        var musicIcon = document.getElementById('musicIcon');
        
        if (musicPlayer && musicToggle) {
          // Detect if this is a fresh load (hard refresh, browser restart) vs navigation
          var isNavigating = sessionStorage.getItem('isNavigating') === 'true';
          var navigationType = performance.getEntriesByType('navigation')[0]?.type;
          var isReload = navigationType === 'reload';
          var referrer = document.referrer || '';
          var currentOrigin = window.location.origin;
          var isFromSameSite = referrer && referrer.indexOf(currentOrigin) === 0;
          
          // Only consider it navigation if we came from the same site AND the flag was set
          // This ensures we only restore music state for actual internal navigation
          var isInternalNavigation = isNavigating && isFromSameSite;
          var isHardRefresh = isReload && !isInternalNavigation;
          
          // Get user preference (persists across hard resets)
          var userPreference = localStorage.getItem('musicUserPreference'); // 'playing' or 'stopped'
          
          // If this is a fresh load (hard refresh, new browser session, or external link), reset navigation state
          // But keep user preference for persistent behavior
          if (!isInternalNavigation || isHardRefresh) {
            localStorage.removeItem('musicPlaying');
            localStorage.removeItem('musicStopped');
            localStorage.removeItem('musicTime');
          }
          
          // Always clear the navigation flag on page load - it will be set again if user clicks internal link
          // This prevents stale flags from causing issues after clicking external links
          sessionStorage.removeItem('isNavigating');
          
          // Set volume to 50%
          musicPlayer.volume = 0.5;
          
          // Check saved state (after potential reset)
          // User preference always takes precedence - if user paused, respect that across all pages
          var wasPlaying = false;
          var wasStopped = false;
          var savedTime = 0;
          
          // First check user preference - if user paused, always respect that
          if (userPreference === 'stopped') {
            wasStopped = true;
            wasPlaying = false;
            savedTime = 0;
          } else if (isInternalNavigation) {
            // Internal navigation: use navigation state for seamless playback
            // Only if user hasn't explicitly stopped
            wasPlaying = localStorage.getItem('musicPlaying') === 'true';
            wasStopped = localStorage.getItem('musicStopped') === 'true';
            savedTime = parseFloat(localStorage.getItem('musicTime')) || 0;
          } else {
            // Fresh load or hard refresh: use user preference
            wasStopped = userPreference === 'stopped';
            wasPlaying = userPreference === 'playing';
            savedTime = 0; // Start from beginning on fresh load/hard refresh
          }
          
          // Function to save playing state and position
          function savePlayingState() {
            if (!musicPlayer.paused) {
              localStorage.setItem('musicPlaying', 'true');
              localStorage.setItem('musicStopped', 'false');
              localStorage.setItem('musicTime', musicPlayer.currentTime.toString());
              // Save user preference (persists across hard resets)
              localStorage.setItem('musicUserPreference', 'playing');
            }
          }
          
          // Function to save paused state
          function savePausedState() {
            localStorage.setItem('musicStopped', 'true');
            localStorage.setItem('musicPlaying', 'false');
            localStorage.setItem('musicTime', musicPlayer.currentTime.toString());
            // Save user preference (persists across hard resets)
            localStorage.setItem('musicUserPreference', 'stopped');
          }
          
          // Wait for audio to be ready before restoring position
          musicPlayer.addEventListener('loadedmetadata', function() {
            // Restore playback position if music was playing
            if (wasPlaying && !wasStopped && savedTime > 0) {
              musicPlayer.currentTime = savedTime;
            }
          });
          
          // Resume playing if it was playing and user hasn't stopped it
          if (wasPlaying && !wasStopped) {
            // Wait for audio to load and set position
            musicPlayer.addEventListener('canplaythrough', function() {
              if (savedTime > 0) {
                musicPlayer.currentTime = savedTime;
              }
              musicPlayer.play().then(function() {
                musicIcon.textContent = 'â¸';
              }).catch(function(error) {
                console.log('Autoplay blocked by browser:', error);
                musicIcon.textContent = 'â–¶';
              });
            }, { once: true });
            
            // Also try to load the audio
            musicPlayer.load();
          } else if (!wasStopped) {
            // First visit - try to autoplay
            setTimeout(function() {
              musicPlayer.play().then(function() {
                musicIcon.textContent = 'â¸';
              }).catch(function(error) {
                console.log('Autoplay blocked by browser:', error);
                musicIcon.textContent = 'â–¶';
              });
            }, 100);
          } else {
            // User had stopped it - restore position but don't play
            if (savedTime > 0) {
              musicPlayer.addEventListener('loadedmetadata', function() {
                musicPlayer.currentTime = savedTime;
              }, { once: true });
              musicPlayer.load();
            }
            musicIcon.textContent = 'â–¶';
          }
          
          // Update icon and save state when playing
          musicPlayer.addEventListener('play', function() {
            musicIcon.textContent = 'â¸';
            savePlayingState();
          });
          
          // Update icon and save state when paused
          musicPlayer.addEventListener('pause', function() {
            musicIcon.textContent = 'â–¶';
            // Only mark as stopped if music was actually playing (not just failed to start)
            if (musicPlayer.currentTime > 0 || wasPlaying) {
              savePausedState();
            }
          });
          
          // Save position continuously while playing (for seamless cross-page navigation)
          var saveInterval = setInterval(function() {
            if (!musicPlayer.paused) {
              localStorage.setItem('musicTime', musicPlayer.currentTime.toString());
            }
          }, 200); // Save position every 200ms for seamless transition
          
          // Toggle play/pause on button click
          musicToggle.addEventListener('click', function() {
            if (musicPlayer.paused) {
              musicPlayer.play();
            } else {
              musicPlayer.pause();
            }
          });
          
          // Track clicks on links to set navigation flag
          document.addEventListener('click', function(e) {
            var link = e.target.closest('a');
            if (link && link.href) {
              try {
                var linkUrl = new URL(link.href, window.location.href);
                var currentUrl = new URL(window.location.href);
                var isSameOrigin = linkUrl.origin === currentUrl.origin;
                var opensInNewTab = link.target === '_blank' || link.hasAttribute('target');
                
                if (isSameOrigin && !opensInNewTab) {
                  // Internal link that navigates in same tab - set flag for seamless navigation
                  sessionStorage.setItem('isNavigating', 'true');
                } else if (!isSameOrigin) {
                  // External link (different origin) - clear flag to reset on return
                  sessionStorage.removeItem('isNavigating');
                }
                // Same-origin links with target="_blank" (like PDFs) don't affect flag
                // This allows music to continue when opening files on same site
              } catch (err) {
                // Invalid URL, clear flag to be safe
                sessionStorage.removeItem('isNavigating');
              }
            }
          }, true);
          
          // Save state before page unload (for cross-page persistence)
          window.addEventListener('beforeunload', function() {
            clearInterval(saveInterval);
            // Only save if we're actually navigating internally (flag was set)
            if (sessionStorage.getItem('isNavigating') === 'true') {
              if (!musicPlayer.paused) {
                localStorage.setItem('musicPlaying', 'true');
                localStorage.setItem('musicStopped', 'false');
                localStorage.setItem('musicTime', musicPlayer.currentTime.toString());
              } else {
                localStorage.setItem('musicPlaying', 'false');
                localStorage.setItem('musicTime', musicPlayer.currentTime.toString());
              }
            }
          });
          
          // Also save on pagehide (more reliable than beforeunload)
          window.addEventListener('pagehide', function() {
            clearInterval(saveInterval);
            // Only save if we're actually navigating internally (flag was set)
            if (sessionStorage.getItem('isNavigating') === 'true') {
              if (!musicPlayer.paused) {
                localStorage.setItem('musicPlaying', 'true');
                localStorage.setItem('musicStopped', 'false');
                localStorage.setItem('musicTime', musicPlayer.currentTime.toString());
              } else {
                localStorage.setItem('musicPlaying', 'false');
                localStorage.setItem('musicTime', musicPlayer.currentTime.toString());
              }
            }
          });
          
          // Save on visibility change (when user switches tabs)
          document.addEventListener('visibilitychange', function() {
            if (!musicPlayer.paused) {
              savePlayingState();
            }
          });
        }
      });
    </script>
    <script src="headerscript.js" defer></script>
  </head>
  <body>
    <!-- Music Player -->
    <div class="music-player" id="musicPlayer">
      <button class="music-toggle" id="musicToggle" aria-label="Toggle music">
        <span class="music-icon" id="musicIcon">â–¶</span>
      </button>
      <audio id="backgroundMusic" loop>
        <!-- Replace with your music file path -->
        <source src="music/AC DC - Shoot To Thrill.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    </div>
    <header>
      <nav> 
        <div id="header-placeholder">
          <!-- your SVG logo and header content unchanged -->
          <svg id="my-logo" class="logo-header" alt="Logo" version="1.0" xmlns="http://www.w3.org/2000/svg" width="689.000000pt" height="633.000000pt" viewBox="0 0 689.000000 633.000000" preserveAspectRatio="xMidYMid meet">
            <g id="logosvg" transform="translate(0.000000,633.000000) scale(0.100000,-0.100000)" stroke="none" fill="#ffffff">
              <path id="logo-variable" d="M507 4863 c-4 -3 -7 -152 -7 -330 l0 -323 335 0 335 0 0 -1332 0
              -1333 330 330 330 330 0 1002 0 1003 999 0 1000 0 323 326 c178 179 325 327
              327 330 2 2 -889 4 -1981 4 -1091 0 -1988 -3 -1991 -7z" style="fill: #2980b9"/>
              <path d="M4227 4472 l-327 -327 -2 -1005 -3 -1005 -1000 -3 -1000 -2 -330
              -330 -330 -330 1658 0 1657 0 0 335 0 335 392 -2 393 -3 123 -215 c68 -118
              154 -267 191 -330 l67 -115 377 -3 c207 -1 377 0 377 3 0 2 -22 42 -49 87 -46
              77 -1130 1958 -1218 2113 -22 39 -84 147 -138 240 -54 94 -130 226 -170 295
              -40 69 -98 170 -130 225 -32 55 -91 158 -132 230 -41 71 -75 130 -76 132 -2 1
              -150 -145 -330 -325z m375 -1064 c20 -35 104 -181 187 -325 83 -144 151 -267
              151 -273 0 -6 -67 -10 -195 -10 l-195 0 0 335 c0 184 4 335 8 335 4 0 24 -28
              44 -62z"/>
              <path d="M2898 3139 l-318 -324 317 -3 c174 -1 318 -1 320 1 2 2 2 149 1 327 l-3 323 -317 -324z"/>
            </g>
          </svg>
        </div>
        <button class="hamburger" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="nav-menu">
          <a href="index.html">Home</a>
          <a href="about.html">About</a>
          <a href="me/Miguel's CV.pdf" target="_blank" rel="noopener noreferrer">Resume</a>
        </div>
      </nav>
    </header>

    <section id="about-2">
      <div class="about-content-2">
        <img src="me/IMG_7.JPEG" alt="Profile Picture" class="profile-image">
        <div class="about-text-2">
          <h2>About Me</h2>
          <span class="underline"></span>
          <p class="p1">I design systems, solve problems, and chase dreams â€” always choosing the edge of discomfort as my playground.</p>
          <p class="p2">I bring structure to chaos and lead by example. Grounded in pragmatism but never blind to detail, I stay deeply committed to my responsibilities and driven by an insatiable thirst for learning.</p>
          <p class="p3">These are the values that define me â€” as a person, a developer, and a leader.</p>
        </div>
      </div>
      <div class="scroll-down">
        <a href="#life-timeline"></a>
      </div>
    </section>

    <section id="life-timeline">
      <div class="container">
        <h2>Life Timeline</h2>
        <span class="underline"></span>

        <!-- Controls Section -->
        <div class="timeline-controls">
          <div class="filter-section">
            <h3>Filter by Category:</h3>
            <div class="filter-buttons">
              <button class="filter-btn active" data-category="all">All</button>
              <button class="filter-btn" data-category="studies">Studies</button>
              <button class="filter-btn" data-category="personal">Personal</button>
              <button class="filter-btn" data-category="professional">Professional</button>
              <button class="filter-btn" data-category="travels">Travels</button>
            </div>
          </div>

          <div class="date-sort-row">
            <div class="date-filter-section">
              <label for="year-filter-select">Filter by Date:</label>
              <select id="year-filter-select">
                <option value="">All Years</option>
              </select>
              <select id="month-filter-select" disabled>
                <option value="">All Months</option>
              </select>
            </div>

            <div class="sort-section">
              <button class="sort-toggle-btn" id="sort-toggle" aria-label="Toggle sort order">
                <span class="sort-label">Sort:</span>
                <span class="sort-value" id="sort-value">Newest First</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Timeline Events Grid -->
        <div class="timeline-grid" id="timeline-grid">
          <div class="loading-message" id="loading-message">
            <p>Loading events...</p>
          </div>
        </div>

        <!-- No Results Message -->
        <div class="no-results" id="no-results" style="display: none;">
          <p>No events found for the selected filter.</p>
        </div>
      </div>
    </section>

    <footer>
      <div class="container">
        <div class="social-icons">
          <a href="https://www.linkedin.com/in/toamig/" target="_blank" rel="noopener noreferrer">
            <img src="socials/linkedin.svg" class="logo" alt="Linkedin">
          </a>
          <a href="https://www.instagram.com/toamig/" target="_blank" rel="noopener noreferrer">
            <img src="socials/insta.svg" class="logo" alt="Instagram">
          </a>
          <a href="https://github.com/toamig" target="_blank" rel="noopener noreferrer">
            <img src="socials/github.svg" class="logo" alt="Github">
          </a>
          <a href="https://t.me/cvieiratoa" target="_blank" rel="noopener noreferrer">
            <img src="socials/telegram.svg" class="logo" alt="Telegram">
          </a>
        </div>
        <p>&copy; 2025 Toamig's Game Developer Portfolio. All rights reserved.</p>
      </div>
    </footer>

    <script>
      // -------------------------
      // Helpers
      // -------------------------
      function escapeHtml(s = '') {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      // Converts a plaintext block into a container with <p> paragraphs.
      // Splits paragraphs on blank lines. Single newlines become <br>.
      function createParagraphsFromText(text) {
        const container = document.createElement('div');
        container.className = 'event-extended-description';
        if (!text) return container;
        const normalized = String(text).replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        const parts = normalized.split(/\n{2,}/g); // split on blank lines
        parts.forEach(pText => {
          const p = document.createElement('p');
          const withLineBreaks = escapeHtml(pText).replace(/\n/g, '<br>');
          p.innerHTML = withLineBreaks;
          container.appendChild(p);
        });
        return container;
      }

      // -------------------------
      // Data & state
      // -------------------------
      let lifeEvents = []; // filled from events.json or fallback
      let currentFilter = 'all';
      let currentSort = 'date-desc';
      let currentYearFilter = '';
      let currentMonthFilter = '';

      // Embedded fallback data (used if events.json not found)
      const embeddedLifeEvents = [
        {
          id: "evt-2016-university",
          date: "2016-09-01",
          title: "Started University",
          category: "studies",
          description: "The beginning of one of the most intense and rewarding chapters of my life â€” university!",
          extendedDescription: "In 2016 I started one of the most important chapters of my life. I was prepared for it, so I made sure to party hard and study even harder.\n\nUniversity is a mix of feelings and experiences that make us grow in a lot of directions. Fortunately, I left with a great baggage and ready to face the working life.\n\nThere were all-nighters, coffee-fueled code sessions, and friendships that still matter today.",
          images: []
        },
        {
          id: "evt-2018-first-game",
          date: "2018-03-15",
          title: "First Game Project",
          category: "personal",
          description: "Created my first complete game project and discovered a passion for game development.",
          extendedDescription: "This prototype helped me learn iteration cycles, asset pipelines and build/deploy basics.\n\nI shipped a small demo and learned a lot about gameplay loops.",
          images: ["projects/first-game-screenshot.jpg"],
          links: [{ text: "Prototype (Web build)", url: "https://example.com/first-game" }]
        }
      ];

      // -------------------------
      // Load events (attempt events.json then fallback)
      // -------------------------
      async function loadEvents() {
        const loadingMessage = document.getElementById('loading-message');
        try {
          const resp = await fetch('/events.json', { cache: 'no-cache' });
          if (!resp.ok) throw new Error('no remote json');
          const data = await resp.json();
          if (!Array.isArray(data)) throw new Error('events.json must be an array');
          lifeEvents = data;
        } catch (e) {
          console.info('events.json not found or invalid, using embedded fallback', e);
          lifeEvents = embeddedLifeEvents;
        } finally {
          if (loadingMessage) loadingMessage.style.display = 'none';
        }
        initTimeline();
      }

      // -------------------------
      // Timeline logic
      // -------------------------
      function initTimeline() {
        initLightbox();
        renderEvents();
        setupEventListeners();
      }

      function getAvailableYears() {
        const years = new Set();
        lifeEvents.forEach(ev => {
          if (ev.date && ev.date.length >= 4) years.add(ev.date.substring(0,4));
        });
        return Array.from(years).sort((a,b) => b.localeCompare(a));
      }

      function getAvailableMonths(year) {
        const months = new Set();
        lifeEvents.forEach(ev => {
          if (ev.date && ev.date.length >= 7 && ev.date.substring(0,4) === year) {
            months.add(ev.date.substring(5,7));
          }
        });
        return Array.from(months).sort((a,b) => a.localeCompare(b));
      }

      function populateYearDropdown() {
        const sel = document.getElementById('year-filter-select');
        if (!sel) return;
        sel.innerHTML = '<option value=\"\">All Years</option>';
        getAvailableYears().forEach(y => {
          const opt = document.createElement('option');
          opt.value = y; opt.textContent = y;
          sel.appendChild(opt);
        });
      }

      function populateMonthDropdown(year) {
        const sel = document.getElementById('month-filter-select');
        if (!sel) return;
        sel.innerHTML = '<option value=\"\">All Months</option>';
        getAvailableMonths(year).forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          const monthNames = { '01':'January','02':'February','03':'March','04':'April','05':'May','06':'June','07':'July','08':'August','09':'September','10':'October','11':'November','12':'December' };
          opt.textContent = monthNames[m] || m;
          sel.appendChild(opt);
        });
      }

      function setupEventListeners() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.category;
            renderEvents();
          });
        });

        const yearSel = document.getElementById('year-filter-select');
        const monthSel = document.getElementById('month-filter-select');
        if (yearSel) {
          populateYearDropdown();
          yearSel.addEventListener('change', function() {
            currentYearFilter = this.value;
            currentMonthFilter = '';
            monthSel.value = '';
            if (currentYearFilter) {
              populateMonthDropdown(currentYearFilter);
              monthSel.disabled = false;
            } else {
              monthSel.innerHTML = '<option value=\"\">All Months</option>';
              monthSel.disabled = true;
            }
            renderEvents();
          });
        }
        if (monthSel) {
          monthSel.addEventListener('change', function() {
            currentMonthFilter = this.value;
            renderEvents();
          });
        }

        const sortToggle = document.getElementById('sort-toggle');
        const sortValue = document.getElementById('sort-value');
        if (sortToggle) {
          sortToggle.addEventListener('click', function() {
            currentSort = (currentSort === 'date-desc') ? 'date-asc' : 'date-desc';
            sortValue.textContent = (currentSort === 'date-desc') ? 'Newest First' : 'Oldest First';
            renderEvents();
          });
        }

        // keyboard accessible toggle
        const grid = document.getElementById('timeline-grid');
        if (grid) {
          grid.addEventListener('keydown', (e) => {
            const target = e.target.closest && e.target.closest('.clickable-card[tabindex]');
            if (!target) return;
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              target.click();
            }
          });
        }
      }

      function filterEvents(events) {
        let res = events.slice();
        if (currentFilter && currentFilter !== 'all') {
          res = res.filter(e => {
            // Support multiple tags: check for tags array, categories array, or fallback to single category
            let eventTags = [];
            if (Array.isArray(e.tags)) {
              eventTags = e.tags;
            } else if (Array.isArray(e.categories)) {
              eventTags = e.categories;
            } else if (e.category) {
              eventTags = [e.category];
            }
            // Event matches if any of its tags matches the current filter
            return eventTags.includes(currentFilter);
          });
        }
        if (currentYearFilter) {
          res = res.filter(e => e.date && e.date.substring(0,4) === currentYearFilter);
          if (currentMonthFilter) {
            res = res.filter(e => e.date && e.date.length >= 7 && e.date.substring(5,7) === currentMonthFilter);
          }
        }
        return res;
      }

      function sortEvents(events) {
        const arr = events.slice();
        switch (currentSort) {
          case 'date-desc': return arr.sort((a,b)=> new Date(b.date) - new Date(a.date));
          case 'date-asc': return arr.sort((a,b)=> new Date(a.date) - new Date(b.date));
          case 'title-asc': return arr.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
          case 'title-desc': return arr.sort((a,b)=> (b.title||'').localeCompare(a.title||''));
          default: return arr;
        }
      }

      function formatDate(dateString) {
        if (!dateString) return '';
        const hasDay = /^\d{4}-\d{2}-\d{2}$/.test(dateString);
        const d = new Date(dateString);
        if (isNaN(d)) return escapeHtml(dateString);
        // Use 'en-US' locale to ensure months are always displayed in English
        const locale = 'en-US';
        if (hasDay) {
          return d.toLocaleDateString(locale, { year:'numeric', month:'long', day:'numeric' });
        } else {
          return d.toLocaleDateString(locale, { year:'numeric', month:'long' });
        }
      }

      function getCategoryInfo(category) {
        const categoryMap = {
          hobbies: { name: 'Hobbies', color: '#f9fbbf' },
          studies: { name: 'Studies', color: '#b8dcff' },
          personal: { name: 'Personal', color: '#f6c48a' },
          professional: { name: 'Professional', color: '#cbc5ff' },
          travels: { name: 'Travels', color: '#c9f3b2' },
          work: { name: 'Work & Career', color: '#cbc5ff' }
        };
        return categoryMap[category] || { name: (category || 'Other'), color: '#dfe6e9' };
      }

      // -------------------------
      // Render events (DOM-based, safe)
      // -------------------------
      function renderEvents() {
        const grid = document.getElementById('timeline-grid');
        const noResults = document.getElementById('no-results');
        if (!grid) return;

        grid.innerHTML = '';
        let filtered = filterEvents(lifeEvents);
        let sorted = sortEvents(filtered);

        if (!sorted || sorted.length === 0) {
          if (noResults) noResults.style.display = 'block';
          return;
        } else {
          if (noResults) noResults.style.display = 'none';
        }

        sorted.forEach(event => {
          // Support multiple tags: check for tags array, categories array, or fallback to single category
          let eventTags = [];
          if (Array.isArray(event.tags)) {
            eventTags = event.tags;
          } else if (Array.isArray(event.categories)) {
            eventTags = event.categories;
          } else if (event.category) {
            eventTags = [event.category];
          }

          // event card
          const card = document.createElement('article');
          card.className = 'event-card';

          // header
          const header = document.createElement('div');
          header.className = 'event-header';
          
          // Create container for multiple tags
          const tagsContainer = document.createElement('div');
          tagsContainer.className = 'event-tags-container';
          eventTags.forEach(tag => {
            const cat = getCategoryInfo(tag);
            const catSpan = document.createElement('span');
            catSpan.className = 'event-category';
            catSpan.style.backgroundColor = cat.color;
            catSpan.textContent = cat.name;
            tagsContainer.appendChild(catSpan);
          });
          
          const dateSpan = document.createElement('span');
          dateSpan.className = 'event-date';
          dateSpan.textContent = formatDate(event.date || '');
          header.appendChild(tagsContainer);
          header.appendChild(dateSpan);

          // content (title + short desc)
          const content = document.createElement('div');
          const isExpandable = !!(event.extendedDescription || (event.images && event.images.length) || (event.links && event.links.length) || (event.documents && event.documents.length));
          content.className = 'event-content';
          const h3 = document.createElement('h3'); h3.textContent = event.title || 'Untitled';
          const shortP = document.createElement('p'); shortP.className = 'event-description'; shortP.textContent = event.description || '';
          content.appendChild(h3); content.appendChild(shortP);
          if (isExpandable) {
            const ind = document.createElement('span'); ind.className = 'expand-indicator'; ind.innerHTML = '&#9660;'; content.appendChild(ind);
          }

          // expandable container
          const expandable = document.createElement('div');
          expandable.className = 'event-expandable';

          // extended description (paragraph aware)
          if (event.extendedDescription) {
            const extNode = createParagraphsFromText(event.extendedDescription);
            expandable.appendChild(extNode);
          }

          // images
          if (Array.isArray(event.images) && event.images.length > 0) {
            const imagesWrap = document.createElement('div'); imagesWrap.className = 'event-images';
            event.images.forEach((imgSrc, idx) => {
              if (!imgSrc) return;
              const img = document.createElement('img');
              img.className = (event.images.length === 1) ? 'event-image full' : 'event-image grid';
              img.src = imgSrc;
              img.alt = event.title || `image ${idx+1}`;
              img.dataset.eventId = String(event.id);
              img.dataset.imageIndex = String(idx);
              // images shouldn't toggle the expansion - they open lightbox
              img.addEventListener('click', (ev) => {
                ev.stopPropagation();
                openImageLightbox(String(event.id), parseInt(img.dataset.imageIndex, 10) || 0);
              });
              imagesWrap.appendChild(img);
            });
            expandable.appendChild(imagesWrap);
          }

          // links
          if (Array.isArray(event.links) && event.links.length > 0) {
            const linksWrap = document.createElement('div'); linksWrap.className = 'event-links';
            event.links.forEach(link => {
              if (!link || !link.url) return;
              const a = document.createElement('a');
              a.className = 'event-link';
              a.href = link.url;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.textContent = link.text || link.label || link.url;
              a.addEventListener('click', ev => ev.stopPropagation());
              linksWrap.appendChild(a);
            });
            expandable.appendChild(linksWrap);
          }

          // documents (PDFs and other documents)
          if (Array.isArray(event.documents) && event.documents.length > 0) {
            const docsWrap = document.createElement('div'); docsWrap.className = 'event-documents';
            event.documents.forEach(doc => {
              if (!doc || !doc.url) return;
              const a = document.createElement('a');
              a.className = 'event-document';
              a.href = doc.url;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              const icon = document.createElement('span');
              icon.className = 'document-icon';
              icon.innerHTML = '&#128196;'; // ðŸ“„ document emoji/icon
              const text = document.createElement('span');
              text.className = 'document-text';
              text.textContent = doc.text || doc.label || doc.name || 'View Document';
              a.appendChild(icon);
              a.appendChild(text);
              a.addEventListener('click', ev => ev.stopPropagation());
              docsWrap.appendChild(a);
            });
            expandable.appendChild(docsWrap);
          }

          // handle toggle - make entire card clickable
          if (isExpandable) {
            card.classList.add('clickable-card');
            card.setAttribute('role','button');
            card.setAttribute('tabindex','0');
            card.addEventListener('click', (e) => {
              // Don't toggle if clicking on links or images
              if (e.target.tagName === 'A' || e.target.tagName === 'IMG' || e.target.closest('a') || e.target.closest('img')) return;
              card.classList.toggle('expanded');
              const indicator = card.querySelector('.expand-indicator');
              if (card.classList.contains('expanded')) indicator.innerHTML = '&#9650;'; else indicator.innerHTML = '&#9660;';
            });
          }

          // assemble card
          card.appendChild(header);
          card.appendChild(content);
          card.appendChild(expandable);

          grid.appendChild(card);
        });
      }

      // -------------------------
      // Image lightbox (basic)
      // -------------------------
      let lightboxModal = null;
      let currentEventImages = [];
      let currentImageIndex = 0;

      function initLightbox() {
        if (document.querySelector('.image-lightbox')) {
          lightboxModal = document.querySelector('.image-lightbox');
          return;
        }
        lightboxModal = document.createElement('div');
        lightboxModal.className = 'image-lightbox';
        lightboxModal.innerHTML = `
          <div class="lightbox-overlay"></div>
          <div class="lightbox-content">
            <button class="lightbox-close" aria-label="Close">&times;</button>
            <button class="lightbox-nav lightbox-prev" aria-label="Previous image">&#8249;</button>
            <button class="lightbox-nav lightbox-next" aria-label="Next image">&#8250;</button>
            <div class="lightbox-image-container">
              <img class="lightbox-image" src="" alt="">
              <div class="lightbox-counter"></div>
            </div>
          </div>
        `;
        document.body.appendChild(lightboxModal);

        lightboxModal.querySelector('.lightbox-close').addEventListener('click', closeLightbox);
        lightboxModal.querySelector('.lightbox-overlay').addEventListener('click', closeLightbox);
        lightboxModal.querySelector('.lightbox-prev').addEventListener('click', () => navigateImage(-1));
        lightboxModal.querySelector('.lightbox-next').addEventListener('click', () => navigateImage(1));
        document.addEventListener('keydown', (e) => {
          if (!lightboxModal || !lightboxModal.classList.contains('active')) return;
          if (e.key === 'Escape') closeLightbox();
          if (e.key === 'ArrowLeft') navigateImage(-1);
          if (e.key === 'ArrowRight') navigateImage(1);
        });
      }

      function openImageLightbox(eventId, imageIndex) {
        const ev = lifeEvents.find(x => String(x.id) === String(eventId));
        if (!ev || !Array.isArray(ev.images) || ev.images.length === 0) return;
        currentEventImages = ev.images.filter(Boolean);
        currentImageIndex = Math.min(Math.max(0, imageIndex || 0), currentEventImages.length - 1);
        updateLightboxImage();
        lightboxModal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeLightbox() {
        if (!lightboxModal) return;
        lightboxModal.classList.remove('active');
        document.body.style.overflow = '';
      }

      function navigateImage(delta) {
        if (!currentEventImages || currentEventImages.length === 0) return;
        currentImageIndex = (currentImageIndex + delta + currentEventImages.length) % currentEventImages.length;
        updateLightboxImage();
      }

      function updateLightboxImage() {
        if (!lightboxModal) return;
        const imgEl = lightboxModal.querySelector('.lightbox-image');
        const counterEl = lightboxModal.querySelector('.lightbox-counter');
        if (!imgEl) return;
        imgEl.src = currentEventImages[currentImageIndex] || '';
        counterEl.textContent = `${currentImageIndex + 1} / ${currentEventImages.length}`;
      }

      // -------------------------
      // Init
      // -------------------------
      document.addEventListener('DOMContentLoaded', loadEvents);
    </script>
  </body>
</html>
